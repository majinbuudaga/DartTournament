<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tournament Bracket</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
    }
    nav {
      background: #222;
      color: #fff;
      padding: 10px;
      display: flex;
      gap: 20px;
    }
    nav a {
      color: #fff;
      text-decoration: none;
    }
    h1 {
      text-align: center;
      margin-top: 20px;
    }
    .container {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin-top: 20px;
      position: relative;
    }
    .half-bracket {
      display: flex;
      gap: 20px;
      position: relative;
    }
    .round {
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: relative;
    }
    .match {
      display: flex;
      flex-direction: column;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 5px;
      background: white;
      min-width: 160px;
      text-align: center;
      position: relative;
    }
    .team {
      padding: 5px;
      cursor: pointer;
      border-radius: 4px;
    }
    .team:hover {
      background: #eee;
    }
    .winner {
      background: #c8f7c5;
      font-weight: bold;
    }
    .champion {
      background: gold;
      font-weight: bold;
    }
    .form {
      text-align: center;
      margin: 20px;
    }
    textarea {
      width: 300px;
      height: 200px;
    }
    svg.connector {
      position: absolute;
      top: 0;
      left: 0;
      overflow: visible;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .final-match {
      margin: 40px auto;
      max-width: 300px;
    }
  </style>
</head>
<body>

<nav>
  <a href="#">üèÜ Bracket</a>
</nav>

<h1>Create Tournament</h1>

<div class="form">
  <label for="playerNames">Enter player names (one per line):</label><br>
  <textarea id="playerNames" placeholder="Alice&#10;Bob&#10;Charlie&#10;..."></textarea><br>
  <button onclick="createTeams()">Generate Teams</button>
</div>

<div class="container" id="bracket-container"></div>

<script>
let rounds = [];

function createTeams() {
  const input = document.getElementById("playerNames").value.trim();
  if (!input) return alert("Please enter player names");

  let players = input.split("\n").map(p => p.trim()).filter(p => p);
  shuffle(players);

  const teams = [];
  for (let i = 0; i < players.length; i += 2) {
    const teamMembers = players.slice(i, i + 2);
    teams.push("Team " + teamMembers.join(" & "));
  }

  localStorage.setItem("tournamentTeams", JSON.stringify(teams));
  createBracket(teams);
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function createBracket(teams) {
  rounds = [];
  const firstRound = [];
  for (let i = 0; i < teams.length; i += 2) {
    firstRound.push([teams[i], teams[i + 1] || null]);
  }
  rounds.push(firstRound);

  let next = Math.ceil(firstRound.length / 2);
  while (next >= 1) {
    const r = new Array(next).fill([null, null]);
    rounds.push(r);
    next = Math.ceil(next / 2);
  }

  drawBracket();
}

function drawBracket() {
  const container = document.getElementById("bracket-container");
  container.innerHTML = "";

  const leftRounds = rounds.map((r, idx) => (idx < rounds.length - 1 ? r.slice(0, Math.ceil(r.length / 2)) : []));
  const rightRounds = rounds.map((r, idx) => (idx < rounds.length - 1 ? r.slice(Math.ceil(r.length / 2)) : []));

  const matchRefs = [];

  function renderHalf(roundsSlice, containerEl, offset) {
    const halfDiv = document.createElement("div");
    halfDiv.className = "half-bracket";

    roundsSlice.forEach((round, rIdx) => {
      const roundDiv = document.createElement("div");
      roundDiv.className = "round";
      matchRefs[rIdx + offset] = matchRefs[rIdx + offset] || [];

      round.forEach((match, mIdx) => {
        const matchDiv = document.createElement("div");
        matchDiv.className = "match";

        match.forEach((team, tIdx) => {
          const teamDiv = document.createElement("div");
          teamDiv.className = "team";
          teamDiv.innerHTML = team || "<em>?</em>";
          if (team) {
            teamDiv.onclick = () => handleWinner(rIdx + offset, mIdx, tIdx);
          }
          matchDiv.appendChild(teamDiv);
        });

        roundDiv.appendChild(matchDiv);
        matchRefs[rIdx + offset].push(matchDiv);
      });

      halfDiv.appendChild(roundDiv);
    });

    containerEl.appendChild(halfDiv);
  }

  renderHalf(leftRounds, container, 0);

  // Final match in center
  const finalMatch = rounds[rounds.length - 1][0];
  const finalDiv = document.createElement("div");
  finalDiv.className = "final-match match";
  finalMatch.forEach((team, idx) => {
    const div = document.createElement("div");
    div.className = "team";
    div.innerHTML = team || "<em>?</em>";
    if (team) div.onclick = () => handleWinner(rounds.length - 1, 0, idx);
    finalDiv.appendChild(div);
  });
  container.appendChild(finalDiv);

  renderHalf(rightRounds, container, 0);

  drawLines(matchRefs);
}

function handleWinner(roundIndex, matchIndex, teamIndex) {
  const winner = rounds[roundIndex][matchIndex][teamIndex];
  if (!winner) return;

  const matchEl = document.querySelectorAll(".round")[roundIndex]?.children[matchIndex];
  if (matchEl) {
    [...matchEl.children].forEach((el, idx) => {
      el.classList.remove("winner", "champion");
      if (idx === teamIndex) {
        el.classList.add(roundIndex === rounds.length - 1 ? "champion" : "winner");
      }
    });
  }

  if (roundIndex + 1 < rounds.length) {
    const nextMatchIndex = Math.floor(matchIndex / 2);
    const position = matchIndex % 2;

    const next = [...rounds[roundIndex + 1][nextMatchIndex]];
    next[position] = winner;
    rounds[roundIndex + 1][nextMatchIndex] = next;

    drawBracket();
  }
}

function drawLines(matchRefs) {
  document.querySelectorAll("svg.connector").forEach(e => e.remove());

  for (let r = 0; r < matchRefs.length - 1; r++) {
    const current = matchRefs[r];
    const next = matchRefs[r + 1];
    if (!current || !next) continue;

    for (let i = 0; i < next.length; i++) {
      const from1 = current[i * 2];
      const from2 = current[i * 2 + 1];
      const to = next[i];
      if (!from1 || !from2 || !to) continue;

      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.classList.add("connector");
      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      const b1 = from1.getBoundingClientRect();
      const b2 = from2.getBoundingClientRect();
      const bt = to.getBoundingClientRect();
      const bc = document.getElementById("bracket-container").getBoundingClientRect();

      const x1 = b1.right - bc.left;
      const y1 = (b1.top + b1.bottom) / 2 - bc.top;
      const x2 = b2.right - bc.left;
      const y2 = (b2.top + b2.bottom) / 2 - bc.top;
      const xt = bt.left - bc.left;
      const yt = (bt.top + bt.bottom) / 2 - bc.top;

      path.setAttribute("d", `
        M ${x1} ${y1} 
        L ${x1 + 10} ${y1}
        L ${x1 + 10} ${yt}
        L ${xt} ${yt}
        M ${x2} ${y2} 
        L ${x2 + 10} ${y2}
        L ${x2 + 10} ${yt}
      `);
      path.setAttribute("stroke", "#aaa");
      path.setAttribute("stroke-width", "2");
      path.setAttribute("fill", "none");
      svg.appendChild(path);
      document.getElementById("bracket-container").appendChild(svg);
    }
  }
}

window.onload = () => {
  const saved = JSON.parse(localStorage.getItem("tournamentTeams") || "[]");
  if (saved.length) createBracket(saved);
};
</script>

</body>
</html>
